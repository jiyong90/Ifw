<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmWorktimeMapper">
	<!--근태 이상자 조회 -->
  	<select id="getWorktimeCheckList" parameterType="map" resultType="map">
  		SELECT T.TENANT_ID AS tenantId
		     , T.ENTER_CD AS enterCd
		     , T.ORG_NM AS orgNm
		     , T.SABUN AS sabun
		     , T.EMP_NM AS empNm
		     , T.WORK_TYPE_CD AS workTypeCd
		     , T.FLEXIBLE_NM AS workTypeNm
		     , T.FLEXIBLE_SDATE AS flexibleSdate
		     , T.FLEXIBLE_EDATE AS flexibleEdate
		     , T.WEEK_SDATE AS weekSdate
		     , T.WEEK_EDATE AS weekEdate
		     , CONCAT(FLOOR(T.STD_WORK_MINUTE/60),':',LPAD(MOD(T.STD_WORK_MINUTE,60),2,'0')) AS stdWorkMinute
		     , CONCAT(FLOOR(T.STD_OT_MINUTE/60),':',LPAD(MOD(T.STD_OT_MINUTE,60),2,'0')) AS stdOtMinute
		     , CONCAT(FLOOR((T.STD_WORK_MINUTE+T.STD_OT_MINUTE)/60),':',LPAD(MOD((T.STD_WORK_MINUTE+T.STD_OT_MINUTE),60),2,'0')) AS stdMinute
		     , CONCAT(FLOOR(T.APPR_WORK_MINUTE/60),':',LPAD(MOD(T.APPR_WORK_MINUTE,60),2,'0')) AS apprWorkMinute
		     , CONCAT(FLOOR(T.APPR_OT_MINUTE/60),':',LPAD(MOD(T.APPR_OT_MINUTE,60),2,'0')) AS apprOtMinute
		     , CONCAT(FLOOR((T.APPR_WORK_MINUTE+T.APPR_OT_MINUTE)/60),':',LPAD(MOD((T.APPR_WORK_MINUTE+T.APPR_OT_MINUTE),60),2,'0')) AS apprMinute
			<choose>
			    <when test="searchValue=='ALL'">
	     		, T.APPR_WORK_MINUTE+T.APPR_OT_MINUTE - T.STD_WORK_MINUTE+T.STD_OT_MINUTE AS diffMinute
	     		</when>
	     		<when test="searchValue=='BASE'">
	     		, T.APPR_WORK_MINUTE - T.STD_WORK_MINUTE AS diffMinute
	     		</when>
	     		<when test="searchValue=='OT'">
	     		, T.APPR_OT_MINUTE - STD_OT_MINUTE AS diffMinute
	     		</when>
	     	</choose>
	     	, 0 AS worktimeDetail
	     	, T.NOTE AS note
  		  FROM (
	  		SELECT T.TENANT_ID
			     , T.ENTER_CD
			     , F_WTM_GET_ORG_NM(E.TENANT_ID, E.ENTER_CD, H.ORG_CD, H.SYMD) AS ORG_NM
			     , T.SABUN
			     , H.EMP_NM
			     , T.WORK_TYPE_CD 
			     , M.FLEXIBLE_NM
			     , T.FLEXIBLE_SDATE
			     , T.FLEXIBLE_EDATE
			     , CASE WHEN #{searchType}='TERM' THEN T.FLEXIBLE_SDATE ELSE T.WEEK_SDATE END AS WEEK_SDATE
			     , CASE WHEN #{searchType}='TERM' THEN T.FLEXIBLE_EDATE ELSE T.WEEK_EDATE END AS WEEK_EDATE
			     , CASE WHEN T.WORK_TYPE_CD IN ('SELE_F','SELE_C') THEN E.WORK_MINUTE
			     			WHEN T.WORK_TYPE_CD = 'ELAS' THEN SUM(T.APPR_WORK_MINUTE)
				  			ELSE 40 * 60 END AS STD_WORK_MINUTE
			     , CASE WHEN T.WORK_TYPE_CD IN ('SELE_F','SELE_C') THEN E.OT_MINUTE
				  			ELSE 12 * 60 END AS STD_OT_MINUTE
			     , SUM(APPR_WORK_MINUTE) AS APPR_WORK_MINUTE
			     , SUM(APPR_OT_MINUTE) AS APPR_OT_MINUTE
			     , T.NOTE
			  FROM WTM_WORK_TERM_TIME T
			  JOIN WTM_FLEXIBLE_EMP E
			    ON T.WORK_TYPE_CD = E.WORK_TYPE_CD
			   AND T.TENANT_ID = E.TENANT_ID
			   AND T.ENTER_CD = E.ENTER_CD
			   AND T.SABUN = E.SABUN
			   AND T.FLEXIBLE_SDATE = E.SYMD
			   AND T.FLEXIBLE_EDATE = E.EYMD
			  JOIN WTM_FLEXIBLE_STD_MGR M
			    ON E.FLEXIBLE_STD_MGR_ID = M.FLEXIBLE_STD_MGR_ID
			  JOIN WTM_EMP_HIS H
			    ON E.TENANT_ID = H.TENANT_ID
			   AND E.ENTER_CD = H.ENTER_CD
			   AND E.SABUN = H.SABUN
			   AND E.SYMD BETWEEN H.SYMD AND H.EYMD
			 WHERE T.TENANT_ID = #{tenantId}
			   AND T.ENTER_CD = #{enterCd}
			   AND (#{searchType}='TERM' AND T.WORK_TYPE_CD IN ('SELE_F','SELE_C') AND F_WTM_DATE_FORMAT(#{sYmd},'%Y%m%d') BETWEEN T.FLEXIBLE_SDATE AND T.FLEXIBLE_EDATE
					    OR #{searchType}='WEEK' AND T.WORK_TYPE_CD NOT IN ('SELE_F','SELE_C') AND F_WTM_DATE_FORMAT(#{sYmd},'%Y%m%d') BETWEEN T.FLEXIBLE_SDATE AND T.FLEXIBLE_EDATE 
						 AND F_WTM_DATE_FORMAT(#{sYmd},'%Y%m%d') BETWEEN T.WEEK_SDATE AND T.WEEK_EDATE )
			   AND (#{searchKeyword}='' OR #{searchKeyword} IS NULL OR #{searchKeyword}=T.SABUN OR H.EMP_NM LIKE CONCAT(#{searchKeyword}, '%'))
			GROUP BY T.TENANT_ID, T.ENTER_CD, T.SABUN, T.WORK_TYPE_CD, M.FLEXIBLE_NM, T.FLEXIBLE_SDATE, T.FLEXIBLE_EDATE
		) T
		WHERE 1=1
		<if test="searchValue!='' and searchMinute!='' and searchCondition!=''">
			<choose>
			    <when test="searchValue=='ALL'">
			   		<if test="searchCondition=='more'">
			   			and APPR_WORK_MINUTE+APPR_OT_MINUTE &gt;= CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   		<if test="searchCondition=='under'">
			   			and APPR_WORK_MINUTE+APPR_OT_MINUTE &lt; CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   	</when>
			   	<when test="searchValue=='BASE'">
			   		<if test="searchCondition=='more'">
			   			and APPR_WORK_MINUTE &gt;= CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   		<if test="searchCondition=='under'">
			   			and APPR_WORK_MINUTE &lt; CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   	</when>
			   	<when test="searchValue=='OT'">
			   		<if test="searchCondition=='more'">
			   			and APPR_OT_MINUTE &gt;= CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   		<if test="searchCondition=='under'">
			   			and APPR_OT_MINUTE &lt; CAST(#{searchMinute} AS SIGNED)* 60
			   		</if>
			   	</when>
			</choose>
		</if>
  	</select>
  	
  	<select id="getWorktimeDetail" parameterType="map" resultType="map">
  		SELECT C.YMD AS ymd
		     , M.FLEXIBLE_NM AS flexibleNm
		     , C.ENTRY_SDATE AS entrySdate
			  , C.ENTRY_EDATE AS entryEdate
			  , R.TIME_TYPE_CD AS timeTypeCd
			  , R.TAA_CD AS taaCd
			  , R.PLAN_SDATE AS planSdate
			  , R.PLAN_EDATE AS planEdate
			  , CONCAT(FLOOR(R.PLAN_MINUTE/60),':',LPAD(MOD(R.PLAN_MINUTE,60),2,'0')) AS planMinute
			  , R.APPR_SDATE AS apprSdate
			  , R.APPR_EDATE AS apprEdate
			  , CONCAT(FLOOR(R.APPR_MINUTE/60),':',LPAD(MOD(R.APPR_MINUTE,60),2,'0')) AS apprMinute
			FROM WTM_WORK_CALENDAR C
			JOIN WTM_FLEXIBLE_EMP E
			  ON C.TENANT_ID = E.TENANT_ID
			 AND C.ENTER_CD = E.ENTER_CD
			 AND C.SABUN = E.SABUN
			 AND C.YMD BETWEEN E.SYMD AND E.EYMD
			JOIN WTM_FLEXIBLE_STD_MGR M
			  ON E.FLEXIBLE_STD_MGR_ID = M.FLEXIBLE_STD_MGR_ID
			 AND E.TENANT_ID = M.TENANT_ID
			 AND E.ENTER_CD = M.ENTER_CD
			LEFT OUTER JOIN WTM_WORK_DAY_RESULT R
			  ON C.TENANT_ID = R.TENANT_ID
			 AND C.ENTER_CD = R.ENTER_CD 
			 AND C.SABUN = R.SABUN 
			 AND C.YMD = R.YMD
			WHERE C.YMD BETWEEN #{sYmd} AND #{eYmd}
			  AND C.YMD = R.YMD
			  AND C.TENANT_ID = #{tenantId}
			  AND C.ENTER_CD = #{enterCd}
			  AND C.SABUN = #{sabun}
		ORDER BY F_WTM_TO_DATE(C.YMD,'%Y%m%d'), apprSdate, planSdate
  	</select>
</mapper>
