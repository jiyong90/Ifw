<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmValidatorMapper">
	
  	<select id="checkDuplicateTaa" parameterType="map" resultType="map">
  		<![CDATA[ 
			SELECT COUNT(*) AS cnt FROM (
				SELECT R.*
				  FROM WTM_FLEXIBLE_EMP E
				  JOIN WTM_WORK_CALENDAR C
				    ON E.TENANT_ID = C.TENANT_ID
				   AND E.ENTER_CD = C.ENTER_CD
				   AND E.SABUN = C.SABUN
				   AND C.YMD BETWEEN E.SYMD AND E.EYMD
				  JOIN WTM_WORK_DAY_RESULT R
				    ON C.TENANT_ID = R.TENANT_ID
				   AND C.ENTER_CD = R.ENTER_CD
				   AND C.YMD = R.YMD
				   AND C.SABUN = R.SABUN 
				 WHERE E.TENANT_ID = ${tenantId}
				   AND E.ENTER_CD = ${enterCd}
				   AND E.SABUN = ${sabun}
				   AND R.TIME_TYPE_CD = ${timeTypeCd}
				   AND T.REQUEST_TYPE_CD = ${requestTypeCd}
				   AND C.YMD BETWEEN ${symd} AND ${eymd}
				   -- AND ((F_WTM_DATE_FORMAT(F_WTM_NVL(R.APPR_SDATE, R.PLAN_SDATE),'%Y%m%d%H%i') >= #{sdate} AND F_WTM_DATE_FORMAT(F_WTM_NVL(R.APPR_SDATE, R.PLAN_SDATE),'%Y%m%d%H%i') < #{edate} ) OR ( F_WTM_DATE_FORMAT(F_WTM_NVL(R.APPR_EDATE, R.PLAN_EDATE),'%Y%m%d%H%i') > #{sdate} AND  F_WTM_DATE_FORMAT(F_WTM_NVL(R.APPR_EDATE, R.PLAN_EDATE),'%Y%m%d%H%i') <= #{edate} ))
				 UNION ALL
				SELECT O.*
				  FROM WTM_APPL A
				  JOIN WTM_TAA_APPL O
				    ON A.APPL_ID = O.APPL_ID
				 WHERE A.TENANT_ID = ${tenantId}
				   AND A.ENTER_CD = ${enterCd}
				   AND A.APPL_IN_SABUN = ${sabun}
				   AND (A.APPL_ID <> #{applId} OR #{applId} IS NULL OR #{applId} = '')
				   AND A.APPL_STATUS_CD IN ('21','31')
				   -- AND ((F_WTM_DATE_FORMAT(O.OT_SDATE,'%Y%m%d%H%i') >= #{sdate} AND F_WTM_DATE_FORMAT(O.OT_SDATE,'%Y%m%d%H%i') < #{edate}) OR (F_WTM_DATE_FORMAT(O.OT_EDATE,'%Y%m%d%H%i') > #{sdate} AND F_WTM_DATE_FORMAT(O.OT_EDATE,'%Y%m%d%H%i') <= #{edate}))
				) X
		]]>	
  	</select>
</mapper>
