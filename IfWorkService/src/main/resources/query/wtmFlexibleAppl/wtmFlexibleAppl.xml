<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmFlexibleApplMapper">
	<select id="getLastAppl" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT FA.FLEXIBLE_APPL_ID AS flexibleApplId
			     , FA.FLEXIBLE_STD_MGR_ID AS flexibleStdMgrId
			     , FA.APPL_ID AS applId
			     , FA.YM AS ym
			     , FA.SYMD AS sYmd
			     , FA.EYMD AS eYmd
			     , FA.WORK_DAY AS workDay
			     , FA.REASON AS reason
			     , A.APPL_CD AS applCd
			     , A.APPL_STATUS_CD AS applStatusCd
			     , E.FLEXIBLE_EMP_ID AS flexibleEmpId
			     , E.FLEXIBLE_STD_MGR_ID AS flexibleStdMgrId
			     , M.WORK_SHM AS workShm
			     , M.WORK_EHM AS workEhm
			     , M.CORE_SHM AS coreShm
			     , M.CORE_EHM AS coreEhm
			  FROM WTM_APPL A
			  JOIN WTM_FLEXIBLE_APPL FA
			    ON A.APPL_ID = FA.APPL_ID 
			  LEFT OUTER JOIN WTM_FLEXIBLE_EMP E
			    ON A.TENANT_ID = E.TENANT_ID
			   AND A.ENTER_CD = E.ENTER_CD
			   AND A.APPL_SABUN = E.SABUN
			   AND FA.SYMD = E.SYMD
			   AND FA.EYMD = E.EYMD
			  LEFT OUTER JOIN WTM_FLEXIBLE_STD_MGR M
			    ON E.FLEXIBLE_STD_MGR_ID = M.FLEXIBLE_STD_MGR_ID
			 WHERE A.TENANT_ID = #{tenantId}
			   AND A.ENTER_CD =  #{enterCd}
			   AND (A.APPL_SABUN, FA.SYMD) IN (SELECT A.APPL_SABUN, MAX(SYMD)
											     FROM WTM_APPL A
											     JOIN WTM_FLEXIBLE_APPL FA
											       ON A.APPL_ID = FA.APPL_ID 
											    WHERE A.TENANT_ID = #{tenantId}
											      AND A.ENTER_CD =  #{enterCd}
											      AND A.APPL_SABUN = #{sabun}
											   GROUP BY A.APPL_SABUN )	   
	        ]]>
    </select>
    <update id="updateWorkMinuteOfWtmFlexibleEmp" parameterType="map">
    	<![CDATA[
	    	UPDATE WTM_FLEXIBLE_EMP E
			   SET E.WORK_MINUTE = (
				SELECT SUM(CASE F_WTM_HOLIDAY_YN(D.SUN_YMD, #{1}, #{2}, #{3}, #{4}, #{5}, #{6}, #{7}) WHEN 'Y' THEN 0 WHEN 'N' THEN 1 END * CAST(P.INFO_VALUE AS SIGNED) * 60)
				  FROM WTM_DAY_MGR D
				  JOIN WTM_PROPERTIE P
				    ON 1=1
				   AND P.INFO_KEY = 'OPTION_DEFAULT_WORKTIME'
				 WHERE D.SUN_YMD BETWEEN E.SYMD AND E.EYMD
				)
			 WHERE E.FLEXIBLE_EMP_ID = #{flexibleEmpId}
		 ]]>
    </update>
</mapper>
