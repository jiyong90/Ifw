<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmInterfaceMapper">

	<select id="getIfLastDate" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT F_WTM_DATE_FORMAT(MAX(UPDATE_DATE), 'YMDHIS') AS lastDate
			  FROM WTM_IF_HIS
			 WHERE TENANT_ID = #{tenantId}
			   AND IF_ITEM = #{ifType}
			   AND IF_STATUS = 'OK'
        ]]>
    </select>
    <select id="getIfNowDate" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT F_WTM_DATE_FORMAT(NOW(), 'YMDHIS') AS ifDate
			  FROM DUAL
        ]]>
    </select>
    
    <select id="getIfUrl" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT info_data as infoData
			  FROM comm_management_infomation
			 WHERE tenant_id = #{tenantId}
			   AND info_key = 'HR.IT_URL'
        ]]>
    </select>
    
	<insert id="insertIfHis" parameterType="hashmap">
		INSERT INTO WTM_IF_HIS
		(
			  TENANT_ID
			, IF_STATUS
			, IF_ITEM 
			, IF_SEARCH_DATE 
			, IF_MSG 
			, UPDATE_DATE
		) VALUES (
			  #{tenantId}
			, #{ifStatus}
			, #{ifItem}
			, F_WTM_TO_DATE(#{ifEndDate}, 'YMDHIS')
			, #{ifMsg}
			, F_WTM_TO_DATE(#{updateDate}, 'YMDHIS')
		)
	</insert>
	
	<select id="getWtmCodeId" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT CODE_ID as codeId
			  FROM WTM_CODE
			 WHERE TENANT_ID = #{tenantId}
			   AND ENTER_CD = #{enterCd}
			   AND GRP_CODE_CD = #{grpCodeCd}
			   AND CODE_CD = #{codeCd}
			   AND CODE_NM = #{codeNm}
			   AND SYMD = #{symd}
        ]]>
    </select>
    
    <insert id="insertWtmCode" parameterType="hashmap">
			INSERT INTO WTM_CODE
			(
				  TENANT_ID
				, ENTER_CD 
				, GRP_CODE_CD 
				, CODE_CD 
				, CODE_NM 
				, SYMD 
				, EYMD 
				, SEQ
				, NOTE
				, UPDATE_DATE
				, UPDATE_ID
			) VALUES 
			<foreach collection="list" item="item" separator=", ">
			(     #{item.tenantId}
	        	, #{item.enterCd}
	        	, #{item.grpCodeCd}
	        	, #{item.codeCd}
	        	, #{item.codeNm}
	        	, #{item.symd}
	        	, #{item.eymd}
	        	, #{item.seq}
	        	, #{item.note}
	        	, NOW()
	        	, '0'
	        )
			</foreach>
	</insert>
	
	<update id="updateWtmCode" parameterType="hashmap">
		UPDATE WTM_CODE SET
		    NOTE = CASE
		    <foreach collection="list" item="item" separator="">
		        when CODE_ID = #{item.codeId} then #{item.note}
		    </foreach>
    		END
		  , UPDATE_DATE = NOW()
		  , UPDATE_ID = '0'
		WHERE CODE_ID IN
		<foreach collection="list" item="item" open="(" close=")" separator=", ">
			#{item.codeId}
		</foreach>
	</update>
	
	<update id="updateWtmCodeHisEymd" parameterType="hashmap">
		<![CDATA[
			UPDATE WTM_CODE
			   SET EYMD =F_WTM_NVL(F_WTM_DATE_FORMAT(DATE_ADD(F_WTM_TO_DATE(#{symd}, 'YMD'), INTERVAL -1 DAY), 'YMD'), '29991231')
			  , UPDATE_DATE = NOW()
			  , UPDATE_ID = '0'
			WHERE 1=1
			  AND TENANT_ID = #{tenantId}
			  AND ENTER_CD = #{enterCd}
			  AND GRP_CODE_CD = #{grpCodeCd}
			  AND CODE_CD = #{codeCd}
			  AND #{symd} > SYMD
		]]>
	</update>
	
	<update id="updateWtmCodeHisSymd" parameterType="hashmap" >
        <![CDATA[
			UPDATE WTM_CODE
			   SET SYMD =F_WTM_NVL(F_WTM_DATE_FORMAT(DATE_ADD(F_WTM_TO_DATE(#{eymd}, 'YMD'), INTERVAL -1 DAY), 'YMD'), '29991231')
			  , UPDATE_DATE = NOW()
			  , UPDATE_ID = '0'
			WHERE 1=1
			  AND TENANT_ID = #{tenantId}
			  AND ENTER_CD = #{enterCd}
			  AND GRP_CODE_CD = #{grpCodeCd}
			  AND CODE_CD = #{codeCd}
			  AND #{symd} < SYMD
        ]]>
    </update>
    
    <insert id="insertWtmHoliday" parameterType="java.util.HashMap" >
        INSERT INTO WTM_HOLIDAY_MGR (
        	  TENANT_ID
        	, ENTER_CD
        	, BISINESS_PLACE_CD
        	, HOLIDAY_YMD
        	, HOLIDAY_NM
        	, SUN_YN
        	, FESTIVE_YN
        	, PAY_YN
        	, NOTE
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES 
       <foreach collection="list" item="item" separator=", ">
		(     #{item.tenantId}
        	, #{item.enterCd}
        	, #{item.locationCd}
        	, #{item.holidayYmd}
        	, #{item.holidayNm}
        	, #{item.sunYn}
        	, #{item.festiveYn}
        	, #{item.payYn}
        	, #{item.note}
        	, NOW()
        	, '0'
        )
		</foreach>
        ON DUPLICATE KEY UPDATE
              HOLIDAY_NM = VALUES(HOLIDAY_NM)
            , SUN_YN = VALUES(SUN_YN)
            , FESTIVE_YN = VALUES(FESTIVE_YN)
            , PAY_YN = VALUES(PAY_YN)
            , NOTE = VALUES(NOTE)
            , UPDATE_DATE = NOW()
            , UPDATE_ID = '0'
    </insert>
    
    <select id="getWtmTaaCodeId" parameterType="map" resultType="hashmap">
		SELECT TAA_CODE_ID as taaCodeId
		  FROM WTM_TAA_CODE
		 WHERE TENANT_ID = #{tenantId}
		   AND ENTER_CD = #{enterCd}
		   AND TAA_CD = #{taaCd}
    </select>
    
    <insert id="insertTaaCode" parameterType="hashmap">
		INSERT INTO WTM_TAA_CODE
		(
			  TENANT_ID
			, ENTER_CD 
			, TAA_CD 
			, TAA_NM 
			, TAA_TYPE_CD 
			, HOL_INCL_YN 
			, REQUEST_TYPE_CD 
			, WORK_YN
			, PAY_YN
			, NOTE
			, UPDATE_DATE
			, UPDATE_ID
		) VALUES 
		<foreach collection="list" item="item" separator=", ">
			(
			  #{item.tenantId}
			, #{item.enterCd}
			, #{item.taaCd}
			, #{item.taaNm}
			, #{item.taaTypeCd}
			, #{item.holInclYn}
			, #{item.requestTypeCd}
			, #{item.workYn}
			, #{item.payYn}
			, #{item.note}
			, NOW()
			, '0'
			)
		</foreach>
	</insert>
	
	<update id="updateTaaCode" parameterType="hashmap">
		UPDATE WTM_TAA_CODE SET
		    TAA_NM = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.taaNm}
		    </foreach> END
		  , TAA_TYPE_CD = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.taaTypeCd}
		    </foreach> END
		  , HOL_INCL_YN = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.holInclYn}
		    </foreach> END
		  , REQUEST_TYPE_CD = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.requestTypeCd}
		    </foreach> END
		  , WORK_YN = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.workYn}
		    </foreach> END
		  , PAY_YN = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.payYn}
		    </foreach> END
		  , NOTE = CASE 
		    <foreach collection="list" item="item" separator="">
		        when TAA_CODE_ID = #{item.taaCodeId} then #{item.note}
		    </foreach> END
		  , UPDATE_DATE = NOW()
		  , UPDATE_ID = '0'
		WHERE TAA_CODE_ID IN 
		<foreach collection="list" item="item" open="(" close=")" separator=", ">
			#{item.taaCodeId}
		</foreach>
	</update>
	
	<insert id="insertWtmOrgCode" parameterType="java.util.HashMap" >
        INSERT INTO WTM_ORG_CODE (
        	  TENANT_ID
        	, ENTER_CD
        	, ORG_CD
        	, SYMD
        	, ORG_NM
        	, EYMD
        	, ORG_TYPE
        	, NOTE
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES 
       <foreach collection="list" item="item" separator=", ">
		(     #{item.tenantId}
        	, #{item.enterCd}
        	, #{item.orgCd}
        	, #{item.symd}
        	, #{item.orgNm}
        	, #{item.eymd}
        	, #{item.orgType}
        	, #{item.note}
        	, NOW()
        	, '0'
        )
		</foreach>
        ON DUPLICATE KEY UPDATE
              ORG_NM = VALUES(ORG_NM)
            , ORG_TYPE = VALUES(ORG_TYPE)
            , EYMD = VALUES(EYMD)
            , NOTE = VALUES(NOTE)
            , UPDATE_DATE = NOW()
            , UPDATE_ID = '0'
    </insert>
    
    <update id="updateWtmOrgCodeHisEymd" parameterType="hashmap">
		<![CDATA[
			UPDATE WTM_ORG_CODE
			   SET EYMD =F_WTM_NVL(F_WTM_DATE_FORMAT(DATE_ADD(F_WTM_TO_DATE(#{symd}, 'YMD'), INTERVAL -1 DAY), 'YMD'), '29991231')
			  , UPDATE_DATE = NOW()
			  , UPDATE_ID = '0'
			WHERE 1=1
			  AND TENANT_ID = #{tenantId}
			  AND ENTER_CD = #{enterCd}
			  AND ORG_CD = #{orgCd}
			  AND #{symd} > SYMD
		]]>
	</update>
	
	<update id="updateWtmOrgCodeHisSymd" parameterType="hashmap" >
        <![CDATA[
			UPDATE WTM_ORG_CODE
			   SET SYMD =F_WTM_NVL(F_WTM_DATE_FORMAT(DATE_ADD(F_WTM_TO_DATE(#{eymd}, 'YMD'), INTERVAL -1 DAY), 'YMD'), '29991231')
			  , UPDATE_DATE = NOW()
			  , UPDATE_ID = '0'
			WHERE 1=1
			  AND TENANT_ID = #{tenantId}
			  AND ENTER_CD = #{enterCd}
			  AND ORG_CD = #{orgCd}
			  AND #{symd} < SYMD
        ]]>
    </update>
    
    <select id="getWtmOgrChartId" parameterType="map" resultType="hashmap">
		SELECT ORG_CHART_ID as orgChartId
		  FROM WTM_ORG_CHART
		 WHERE TENANT_ID = #{tenantId}
		   AND ENTER_CD = #{enterCd}
		   AND SYMD = #{symd}
    </select>
    
    <insert id="insertWtmOrgChart" parameterType="java.util.HashMap" >
        INSERT INTO WTM_ORG_CHART (
        	  TENANT_ID
        	, ENTER_CD
        	, ORG_CHART_NM
        	, SYMD
        	, EYMD
        	, NOTE
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES 
       
		(     #{tenantId}
        	, #{enterCd}
        	, #{orgChartNm}
        	, #{symd}
        	, #{eymd}
        	, #{note}
        	, NOW()
        	, '0'
        )
    </insert>
    
    <update id="updateWtmOrgChart" parameterType="hashmap">
		UPDATE WTM_ORG_CHART SET
		    ORG_CHART_NM = #{orgChartNm}
		  , EYMD = #{eymd}
		  , NOTE = #{note}
		  , UPDATE_DATE = NOW()
		  , UPDATE_ID = '0'
		WHERE ORG_CHART_ID = #{orgChartId}
	</update>
	
    <insert id="insertWtmOrgChartDet" parameterType="java.util.HashMap" >
        INSERT INTO WTM_ORG_CHART_DET (
        	  ORG_CHART_ID
        	, ORG_CD
        	, PRIOR_ORG_CD
        	, SEQ
        	, ORG_LEVEL
        	, ORDER_SEQ
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES 
       <foreach collection="list" item="item" separator=", ">
		(     #{item.orgChartId}
        	, #{item.orgCd}
        	, #{item.priorOrgCd}
        	, #{item.seq}
        	, #{item.orgLevel}
        	, #{item.orderSeq}
        	, NOW()
        	, '0'
        )
		</foreach>
        ON DUPLICATE KEY UPDATE
              PRIOR_ORG_CD = VALUES(PRIOR_ORG_CD)
            , SEQ = VALUES(SEQ)
            , ORG_LEVEL = VALUES(ORG_LEVEL)
            , ORDER_SEQ = VALUES(ORDER_SEQ)
            , UPDATE_DATE = NOW()
            , UPDATE_ID = '0'
    </insert>
	
	<insert id="insertEmpHisTemp" parameterType="hashmap">
		INSERT INTO WTM_IF_EMP_TEMP
		(
			  TENANT_ID
			, ENTER_CD
			, SABUN
			, EMP_NM
			, EMP_ENG_NM
			, SYMD
			, EYMD
			, STATUS_CD
			, ORG_CD
			, BUSINESS_PLACE_CD
			, DUTY_CD
			, POS_CD
			, CLASS_CD
			, JOB_GROUP_CD
			, JOB_CD
			, PAY_TYPE_CD
			, LEADER_YN
			, NOTE
		) VALUES 
		<foreach collection="list" item="item" separator=", ">
			(
			  #{item.tenantId}
			, #{item.enterCd}
			, #{item.sabun}
			, #{item.empNm}
			, #{item.empEngNm}
			, #{item.symd}
			, #{item.eymd}
			, #{item.statusCd}
			, #{item.orgCd}
			, #{item.businessPlaceCd}
			, #{item.dutyCd}
			, #{item.posCd}
			, #{item.classCd}
			, #{item.jobGroupCd}
			, #{item.jobCd}
			, #{item.payTypeCd}
			, #{item.leaderYn}
			, #{item.note}
			)
		</foreach>
	</insert>
	
	<select id="setEmpHis" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_IF_EMP_HIS( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{nowDataTime, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}) }
  	</select>
  	
  	<select id="getEmpBaseList" parameterType="map" resultType="hashmap">
  	<![CDATA[
		SELECT A.TENANT_ID AS tenantId 
			 , A.ENTER_CD as enterCd 
			 , A.SABUN as sabun
			 , GREATEST(A.SYMD, F_WTM_DATE_FORMAT(F_WTM_DATE_ADD(NOW(), -1, 'M'), 'YMD')) AS symd
			 , LEAST(A.EYMD, F_WTM_DATE_FORMAT(F_WTM_DATE_ADD(NOW(), 1, 'M'), 'YMD')) AS eymd
			 , '0' as userId
		  FROM WTM_EMP_HIS A
		 INNER JOIN WTM_IF_EMP_MSG B
			 ON A.TENANT_ID = B.TENANT_ID
			AND A.ENTER_CD = B.ENTER_CD
			AND A.SABUN = B.SABUN
			AND A.EYMD = '29991231'
			AND A.STATUS_CD LIKE 'A%'
		 WHERE B.TENANT_ID = #{tenantId}
		   AND F_WTM_DATE_FORMAT(B.UPDATE_DATE, 'YMDHIS') > #{ifEndDate}
		   AND B.CHG_TYPE_CD = 'BUSINESS_PLACE_CD'
		   AND B.NEW_VALUE IS NOT NULL
		 UNION
		 SELECT A.TENANT_ID  AS tenantId 
		 	   , A.ENTER_CD as enterCd 
		 	   , A.SABUN as sabun
		 	   , GREATEST(A.SYMD, F_WTM_DATE_FORMAT(F_WTM_DATE_ADD(NOW(), -1, 'M'), 'YMD')) AS symd
		 	   , LEAST(A.EYMD, F_WTM_DATE_FORMAT(F_WTM_DATE_ADD(NOW(), 1, 'M'), 'YMD')) AS eymd
		 	   , '0' as userId
		  FROM WTM_EMP_HIS A
		 INNER JOIN WTM_IF_EMP_MSG B
			 ON A.TENANT_ID = B.TENANT_ID
			AND A.ENTER_CD = B.ENTER_CD
			AND A.SABUN = B.SABUN
			AND A.EYMD = '29991231'
			AND A.STATUS_CD LIKE 'A%'
		 WHERE B.TENANT_ID = #{tenantId}
		   AND F_WTM_DATE_FORMAT(B.UPDATE_DATE, 'YMDHIS') > #{ifEndDate}
		   AND B.CHG_TYPE_CD = 'STATUS_CD'
		   AND B.OLD_VALUE NOT LIKE 'A%'
		 ORDER BY enterCd, sabun
    ]]>
    </select>
    
    <select id="getEmpBaseEtcList" parameterType="map" resultType="hashmap">
  	<![CDATA[
SELECT 21 AS tenantId
		  , 'SAMHWACROWN' AS enterCd
		  , SABUN AS sabun
		  , SYMD AS symd
		  , EYMD AS eymd
		  , 'HJ' as userId
  FROM WTM_WORKTEAM_EMP
 WHERE WORKTEAM_MGR_ID IN (8,9)
    ]]>
    </select>
        
    <select id="getOrgConcChk" parameterType="map" resultType="hashmap">
  	<![CDATA[
		SELECT A.LEADER_CNT as leaderCnt, B.CONC_CNT as concCnt, C.CONC_CNT as concEndCnt
		  FROM (SELECT COUNT(*) AS LEADER_CNT
							  FROM WTM_EMP_HIS
							 WHERE TENANT_ID = #{tenantId}
							   AND ENTER_CD = #{enterCd}
							   AND ORG_CD = #{orgCd}
							   AND SABUN = #{sabun}
							   AND LEADER_YN = 'Y'
							   AND EYMD = #{eymd}) A
		 INNER JOIN (SELECT COUNT(*) AS CONC_CNT
					  FROM WTM_ORG_CONC
					 WHERE TENANT_ID = #{tenantId}
					   AND ENTER_CD = #{enterCd}
					   AND ORG_CD = #{orgCd}
					   AND SABUN = #{sabun}
					   AND SYMD = #{symd}
					   AND EYMD = #{eymd}) B
		INNER JOIN (SELECT COUNT(*) AS CONC_CNT
					  FROM WTM_ORG_CONC
					 WHERE TENANT_ID = #{tenantId}
					   AND ENTER_CD = #{enterCd}
					   AND ORG_CD = #{orgCd}
					   AND SABUN = #{sabun}
					   AND SYMD = #{symd}
					   AND EYMD <> #{eymd}) C
		    ON 1=1
    ]]>
    </select>
    
    <insert id="insertWtmEmpAddr" parameterType="java.util.HashMap" >
        INSERT INTO WTM_EMP_ADDR (
        	  TENANT_ID
        	, ENTER_CD
        	, SABUN
        	, EMAIL
        	, HAND_PHONE
        	, NOTE
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES 
       <foreach collection="list" item="item" separator=", ">
		(     #{item.tenantId}
        	, #{item.enterCd}
        	, #{item.sabun}
        	, #{item.email}
        	, #{item.handPhone}
        	, #{item.note}
        	, NOW()
        	, '0'
        )
		</foreach>
        ON DUPLICATE KEY UPDATE
              EMAIL = VALUES(EMAIL)
            , HAND_PHONE = VALUES(HAND_PHONE)
            , NOTE = VALUES(NOTE)
            , UPDATE_DATE = NOW()
            , UPDATE_ID = '0'
    </insert>
    
    <insert id="insertOrgConc" parameterType="java.util.HashMap" >
        INSERT INTO WTM_ORG_CONC (
        	  TENANT_ID
        	, ENTER_CD
        	, ORG_CD
        	, SABUN
        	, SYMD
        	, EYMD
        	, UPDATE_DATE
        	, UPDATE_ID
        ) VALUES (     
              #{tenantId}
        	, #{enterCd}
        	, #{orgCd}
        	, #{sabun}
        	, #{symd}
        	, #{eymd}
        	, NOW()
        	, '0'
        )
    </insert>
    
    <update id="updateOrgConcEnd" parameterType="java.util.HashMap" >
        UPDATE WTM_ORG_CONC SET
        	  EYMD = #{eymd}
        	, UPDATE_DATE = NOW()
        	, UPDATE_ID = '0'
         WHERE TENANT_ID = #{tenantId}
           AND ENTER_CD = #{enterCd}
           AND ORG_CD = #{orgCd}
           AND SABUN = #{sabun}
           AND SYMD = #{symd}
    </update>
    
    <select id="setTaaApplIf" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_IF_TAA_APPL( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{taaCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sHm, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eHm, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{ifApplNo, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{status, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{taaApplId,jdbcType=BIGINT, javaType=java.lang.Long, mode=OUT}
  			  , #{applId,jdbcType=BIGINT, javaType=java.lang.Long, mode=OUT}
  			  , #{oldStatus,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>
  	<select id="setTaaApplDayIf" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_IF_TAA_APPL_DAY2( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{taaCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{ymd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sHm, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eHm, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{taaApplId,jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{applId,jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{status,jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{oldStatus,jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{timeTypeCd,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{taaSetYn,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{taaSdate,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{taaEdate,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>
  	
  	
  	<select id="getTaaApplList"  parameterType="map" resultType="hashmap">
        <![CDATA[
		SELECT A.TENANT_ID AS tenantId
			 , A.ENTER_CD AS enterCd
			  , A.SABUN AS sabun
			  , A.TAA_CD AS taaCd
			  , A.SYMD AS sYmd
			  , A.EYMD AS eYmd
			  , A.SHM AS sHm
			  , A.EHM AS eHm
			  , A.TAA_APPL_ID AS taaApplId
			  , A.APPL_ID AS applId
			  , B.APPL_STATUS_CD AS status
			  , '' AS oldStatus
		  FROM WTM_TAA_APPL A
		 INNER JOIN WTM_APPL B
			ON A.APPL_ID = B.APPL_ID
		 WHERE A.TENANT_ID =  #{tenantId}
		 AND A.ENTER_CD = #{enterCd}
		 AND A.APPL_ID = #{applId}
        ]]>
    </select>
  	
  	<select id="getWtmTaaApplId" parameterType="map" resultType="hashmap">
		SELECT TAA_APPL_ID as taaApplId
		  FROM WTM_TAA_APPL
		 WHERE TENANT_ID = #{tenantId}
		   AND ENTER_CD = #{enterCd}
		   AND IF_APPL_NO = #{ifApplNo}
	</select>
	
	<select id="setWorkTimeCloseIf" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_CLOSE_WORKTIME( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{ym, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>
  	
  	<select id="getCloseEmp" parameterType="map" resultType="hashmap">
       	SELECT DISTINCT A.SABUN AS sabun
		  FROM WTM_WORK_CALENDAR A
		 INNER JOIN WTM_FLEXIBLE_EMP B
		    ON A.TENANT_ID = B.TENANT_ID
		   AND A.ENTER_CD = B.ENTER_CD
		   AND A.SABUN = B.SABUN
		   AND A.YMD BETWEEN B.SYMD AND B.EYMD
		 WHERE A.TENANT_ID = #{tenantId}
		   AND A.ENTER_CD = #{enterCd}
		   AND A.YMD BETWEEN #{sYmd} AND #{eYmd}
	<if test="sabun!=null and !sabun.equals('')">
		   AND A.SABUN = #{sabun}
	</if>
		 ORDER BY A.SABUN
  	</select>
  	
  	<select id="setCloseDay" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_CLOSE_DAY( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{worktimeCloseId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{ymd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>
  	
  	<select id="setCloseMonth" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_CLOSE_MONTH( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{worktimeCloseId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{sYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>
  	
  	<select id="getExceptRuleId" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT info_data
			  FROM comm_management_infomation
			 WHERE tenant_id = #{tenantId}
			   AND info_key = 'HR.IT_URL'
        ]]>
    </select>
    
    <select id="setCalcDay" parameterType="Long" resultType="hashmap">
        <![CDATA[
SELECT DISTINCT A.TENANT_ID AS tenantId
	, A.ENTER_CD AS enterCd
	, A.SABUN AS sabun
	  , A.YMD AS ymd
	  , 0 AS gooutCnt		
  FROM WTM_WORK_CALENDAR A
WHERE TENANT_ID = 10
  and UPDATE_ID = 'HJ147'
 ORDER BY A.YMD, A.SABUN
        ]]>
    </select>
    
    <select id="setCalcDayParam"  parameterType="map" resultType="hashmap">
        <![CDATA[
SELECT A.ENTER_CD AS enterCd
	  , A.SABUN AS sabun
	  , A.YMD AS ymd
	  , COUNT(B.SABUN) AS gooutCnt				  
	  , C.FLEXIBLE_EMP_ID AS flexibleEmpId
			  FROM WTM_WORK_CALENDAR A
			  LEFT OUTER JOIN WTM_WORK_DAY_RESULT B
			    ON A.TENANT_ID = B.TENANT_ID
			   AND A.ENTER_CD = B.ENTER_CD
			   AND A.SABUN = B.SABUN
			   AND A.YMD = B.YMD
			   AND B.TIME_TYPE_CD = 'GOBACK'
			 INNER JOIN WTM_FLEXIBLE_EMP C
			    ON A.TENANT_ID = C.TENANT_ID
			   AND A.ENTER_CD = C.ENTER_CD
			   AND A.SABUN = C.SABUN
			   AND A.YMD BETWEEN C.SYMD AND C.EYMD
WHERE A.TENANT_ID = #{tenantId}
  AND A.ENTER_CD = #{enterCd}
  AND A.SABUN = #{sabun}
  AND A.YMD  BETWEEN #{sYmd} AND #{eYmd}
 GROUP BY A.ENTER_CD, A.SABUN, A.YMD
 ORDER BY A.SABUN, A.YMD
        ]]>
    </select>
    
    <select id="getCalcDayLoopEmp" parameterType="Long" resultType="hashmap">
        <![CDATA[
 SELECT A.ENTER_CD AS enterCd
	  , A.SABUN AS sabun
	  , A.SYMD AS sYmd
	  , A.EYMD AS eYmd
			  FROM WTM_FLEXIBLE_EMP A
WHERE A.TENANT_ID = #{tenantId}
  AND A.SYMD = '20191230'
--  AND A.SABUN = '329409'
  AND A.SABUN = '20050818001'
 ORDER BY A.SABUN
        ]]>
    </select>
    
    <update id="deleteCalcDayLoop" parameterType="hashmap">
    	<![CDATA[
    		DELETE
  FROM WTM_WORK_DAY_RESULT
 WHERE TENANT_ID = #{tenantId}
   AND ENTER_CD = #{enterCd}
   AND YMD BETWEEN #{sYmd} AND #{eYmd}
   AND SABUN = #{sabun}
   AND TIME_TYPE_CD NOT IN ('REGA', 'TAA', 'GOBACK', 'OT', 'NIGHT', 'SUBS')
    	]]>
    </update>
    
    <select id="setCalcDayLoop"  parameterType="map" resultType="hashmap">
        <![CDATA[
SELECT A.ENTER_CD AS enterCd
	  , A.SABUN AS sabun
	  , A.YMD AS ymd
	  , COUNT(B.SABUN) AS gooutCnt				  
	  , C.FLEXIBLE_EMP_ID AS flexibleEmpId
			  FROM WTM_WORK_CALENDAR A
			  LEFT OUTER JOIN WTM_WORK_DAY_RESULT B
			    ON A.TENANT_ID = B.TENANT_ID
			   AND A.ENTER_CD = B.ENTER_CD
			   AND A.SABUN = B.SABUN
			   AND A.YMD = B.YMD
			   AND B.TIME_TYPE_CD = 'GOBACK'
			 INNER JOIN WTM_FLEXIBLE_EMP C
			    ON A.TENANT_ID = C.TENANT_ID
			   AND A.ENTER_CD = C.ENTER_CD
			   AND A.SABUN = C.SABUN
			   AND A.YMD BETWEEN C.SYMD AND C.EYMD
WHERE A.TENANT_ID = #{tenantId}
  AND A.ENTER_CD = 'BRS'
  AND A.SABUN NOT IN ('20050818001', '329409')
  AND A.YMD  BETWEEN '20191230' AND '20200126'
 GROUP BY A.ENTER_CD, A.SABUN, A.YMD
 ORDER BY A.YMD, A.SABUN
        ]]>
    </select>
    
    <select id="setCalcDayResult"  parameterType="map" resultType="hashmap">
        <![CDATA[
SELECT ENTER_CD AS enterCd
	  , SABUN AS sabun
	  , YMD AS ymd
	  , TIME_TYPE_CD AS timeTypeCd
	  , F_WTM_DATE_FORMAT(PLAN_SDATE, 'YMDHIS') AS planSdate
	  , F_WTM_DATE_FORMAT(PLAN_EDATE, 'YMDHIS') AS planEdate
	  , (SELECT TIME_CD_MGR_ID FROM WTM_WORK_CALENDAR B 
	      WHERE A.TENANT_ID = B.TENANT_ID
			  AND A.ENTER_CD = B.ENTER_CD
			  AND A.SABUN = B.SABUN
			  AND A.YMD = B.YMD) AS timeCdMgrId
	  , WORK_DAY_RESULT_ID AS workDayResultId
  FROM WTM_WORK_DAY_RESULT A
 WHERE TENANT_ID = #{tenantId}
   AND ENTER_CD = #{enterCd}
   AND SABUN = #{sabun}
	AND YMD = #{ymd} 
	AND TIME_TYPE_CD = 'GOBACK'
 ORDER BY PLAN_SDATE
        ]]>
    </select>
    
    <insert id="insertDayResult" parameterType="map">
    	<![CDATA[
    		INSERT INTO WTM_WORK_DAY_RESULT(TENANT_ID, ENTER_CD, YMD, SABUN, TIME_TYPE_CD, PLAN_SDATE, PLAN_EDATE, PLAN_MINUTE, UPDATE_DATE, UPDATE_ID)
			SELECT C.TENANT_ID, C.ENTER_CD, C.YMD, C.SABUN, 'BASE', C.ENTRY_SDATE, C.ENTRY_EDATE, #{planMinute}, now(), '1'
				  FROM WTM_WORK_CALENDAR C
				 WHERE C.TENANT_ID = #{tenantId}
				   AND C.ENTER_CD = #{enterCd}
				   AND C.YMD = #{ymd} 
				   AND C.SABUN = #{sabun}
    	]]>
    </insert>
    <insert id="updateDayResult" parameterType="map">
    	<![CDATA[
    		UPDATE WTM_WORK_DAY_RESULT SET 
				PLAN_MINUTE = ${planMinute}
				 WHERE TENANT_ID = #{tenantId}
				   AND ENTER_CD = #{enterCd}
				   AND YMD = #{ymd} 
				   AND SABUN = #{sabun}
				   AND TIME_TYPE_CD = 'BASE'
    	]]>
    </insert>
    <insert id="updateDayResult2" parameterType="map">
    	<![CDATA[
    		UPDATE WTM_WORK_DAY_RESULT SET 
				PLAN_MINUTE = ${planMinute}
		    WHERE WORK_DAY_RESULT_ID = ${workDayResultId}
    	]]>
    </insert>
    
        <select id="getWtmCloseDay" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT AA.ENTER_CD AS enterCd, AA.SABUN AS sabun, AA.YMD AS ymd
              FROM (SELECT A.ENTER_CD, A.SABUN, A.YMD, MIN(F_WTM_DATE_FORMAT(B.PLAN_SDATE, 'YMD')) AS SDATE, MAX(F_WTM_DATE_FORMAT(B.PLAN_EDATE, 'YMD')) AS EDATE
                    FROM WTM_WORK_CALENDAR A
                   INNER JOIN WTM_WORK_DAY_RESULT B
                       ON A.TENANT_ID = B.TENANT_ID
                      AND A.ENTER_CD = B.ENTER_CD
                      AND A.SABUN = B.SABUN
                      AND A.YMD = B.YMD
                   WHERE B.TIME_TYPE_CD IN ('BASE', 'REGA', 'OT', 'FIXOT', 'NIGTH')	-- 간주근무나 기본근무일때)
                      AND A.TENANT_ID = #{tenantId}
                      AND A.YMD = #{ymd}
--                      AND A.SABUN = '327979'
                   GROUP BY A.ENTER_CD, A.SABUN, A.YMD
                   ) AA
             WHERE ((#{closeType} = 'A' AND AA.SDATE = AA.EDATE)
                 OR (#{closeType} = 'B' AND AA.SDATE != AA.EDATE))
ORDER BY YMD, SABUN
        ]]>
    </select>
    
    <select id="getApplId" parameterType="map" resultType="hashmap">
        <![CDATA[
        SELECT APPL_ID as applId, APPL_STATUS_CD as oldApplStatusCd
		  FROM WTM_APPL
		 WHERE TENANT_ID = #{tenantId}
		   AND ENTER_CD = #{enterCd}
			AND IF_APPL_NO =#{applNo}
        ]]>
    </select>
    
    <select id="getCloseYnChk" parameterType="map" resultType="hashmap">
        <![CDATA[
        SELECT F_WTM_DATE_DIFF(F_WTM_TO_DATE(#{eymd}, 'YMD'), F_WTM_TO_DATE(#{symd}, 'YMD')) + 1 AS dayCnt
			  , SUM(CLOSE_CNT) AS closeCnt
		  FROM (SELECT CASE F_WTM_NVL(WORK_CLOSE_YN, 'N') WHEN 'Y' THEN 1 ELSE 0 END AS CLOSE_CNT
				  FROM WTM_WORK_CALENDAR
				 WHERE TENANT_ID = #{tenantId}
				   AND ENTER_CD = #{enterCd}
				   AND SABUN = #{sabun}
				   AND YMD BETWEEN #{symd} AND #{eymd}
		) A
        ]]>
    </select>
    
    
    <select id="getTaaList" parameterType="map" resultType="hashmap">
        <![CDATA[
        SELECT A.TENANT_ID AS tenantId
        	 , A.ENTER_CD AS enterCd
        	 , A.SABUN AS sabun
             , B.TAA_CD AS taaCd
             , C.YMD AS ymd
             , B.SHM AS shm
             , B.EHM AS ehm
             , DATE_FORMAT(F_WTM_TO_DATE(CONCAT(C.YMD, B.SHM), 'YMDHIS'), '%Y%m%d%H%i%s') AS taaSdate
			 , CASE WHEN B.SHM > B.EHM THEN DATE_FORMAT(F_WTM_DATE_ADD(F_WTM_TO_DATE(CONCAT(C.YMD, B.EHM), 'YMDHIS'), 1, 'D'), '%Y%m%d%H%i%s')
	         ELSE DATE_FORMAT(F_WTM_TO_DATE(CONCAT(C.YMD, B.EHM), 'YMDHIS'), '%Y%m%d%H%i%s') END AS taaEdate
             , CASE WHEN IFNULL(B.SHM, '') != '' AND IFNULL(B.EHM, '') != ''
		 		  THEN timestampdiff(MINUTE, F_WTM_TO_DATE(CONCAT(C.YMD, B.SHM), 'YMDHI'), F_WTM_TO_DATE(CONCAT(C.YMD, B.EHM), 'YMDHI'))
		 		  WHEN IFNULL(B.TAA_MINUTE,0) > 0 THEN B.TAA_MINUTE
		 		  ELSE 0 END AS workMinute
             , C.TIME_CD_MGR_ID AS timeCdMgrId
             , C.HOLIDAY_YN AS holidayYn
             , F_WTM_NVL(C.WORK_CLOSE_YN, 'N') AS closeYn
             , B.NOTE AS note
		  FROM WTM_TAA_APPL A
		 INNER JOIN WTM_TAA_APPL_DET B
		    ON A.TAA_APPL_ID = B.TAA_APPL_ID
		 INNER JOIN WTM_WORK_CALENDAR C
		    ON A.TENANT_ID = C.TENANT_ID
		   AND A.ENTER_CD = C.ENTER_CD
		   AND A.SABUN = C.SABUN
			AND C.YMD BETWEEN B.SYMD AND B.EYMD
		 WHERE A.TENANT_ID = #{tenantId}
		   AND A.ENTER_CD = #{enterCd}
		   AND A.APPL_ID = #{applId}
		  ORDER BY A.SABUN, C.YMD
        ]]>
    </select>
    
    <select id="getStdMgrList" parameterType="map" resultType="hashmap">
        <![CDATA[
        SELECT F_WTM_NVL(B.UNPLANNED_YN, 'N') AS unplannedYn
             , F_WTM_NVL(B.TAA_TIME_YN, 'N') AS taaTimeYn
             , F_WTM_NVL(B.TAA_WORK_YN, 'N') AS taaWorkYn
	  		 , DATE_FORMAT(F_WTM_TO_DATE(CONCAT(#{ymd}, D.WORK_SHM), 'YMDHIS'), '%Y%m%d%H%i%s') AS taaSdate
			 , CASE WHEN D.WORK_SHM > D.WORK_EHM THEN DATE_FORMAT(F_WTM_DATE_ADD(F_WTM_TO_DATE(CONCAT(#{ymd}, D.WORK_EHM), 'YMDHIS'), 1, 'D'), '%Y%m%d%H%i%s')
	         ELSE DATE_FORMAT(F_WTM_TO_DATE(CONCAT(#{ymd}, D.WORK_EHM), 'YMDHIS'), '%Y%m%d%H%i%s') END AS taaEdate
	         , A.WORK_TYPE_CD AS workTypeCd
		  FROM WTM_FLEXIBLE_EMP A
		 INNER JOIN WTM_FLEXIBLE_STD_MGR B
		    ON A.FLEXIBLE_STD_MGR_ID = B.FLEXIBLE_STD_MGR_ID
		 INNER JOIN WTM_TIME_CD_MGR D
		    ON B.REGARD_TIME_CD_ID = D.TIME_CD_MGR_ID
		 WHERE A.TENANT_ID = #{tenantId}
		   AND A.ENTER_CD = #{enterCd}
		   AND A.SABUN = #{sabun}
		   AND #{ymd} BETWEEN A.SYMD AND A.EYMD
        ]]>
    </select>
    
    <update id="deleteResult" parameterType="hashmap">
		DELETE FROM WTM_WORK_DAY_RESULT 
		 WHERE TENANT_ID = #{tenantId}
		   AND ENTER_CD = #{enterCd}
		   AND SABUN = #{sabun}
		   AND YMD = #{ymd}
		   AND APPL_ID = #{applId}
		   AND TAA_CD = #{taaCd}
	</update>
	
	<select id="getTaaPlanTimeList" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT CASE REQ_TYPE_CD WHEN 'A' THEN SDATE
									   WHEN 'P' THEN F_WTM_DATE_ADD(EDATE, -4, 'H')
									   ELSE SDATE END AS taaSdate
			  , CASE REQ_TYPE_CD WHEN 'A' THEN F_WTM_DATE_ADD(EDATE, -4, 'H')
									   WHEN 'P' THEN EDATE
									   ELSE EDATE END AS taaEdate
		  FROM (
				SELECT F_WTM_TO_DATE(#{taaSdate}, 'YMDHIS') AS SDATE
				     , F_WTM_TO_DATE(#{taaEdate}, 'YMDHIS') AS EDATE
				     , #{reqTypeCd} AS REQ_TYPE_CD
				  FROM DUAL) A
        ]]>
    </select>
    
    <select id="getCompList" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT A.TENANT_ID AS tenantId
				  , A.ENTER_CD AS enterCd
				  , A.SABUN AS sabun
				  , A.SYMD AS symd
				  , A.EYMD AS eymd
				  , C.INFO_VALUE AS gntCd
				  , TRUNCATE(A.ALLOW_MINUTE/60/8,2) AS compCnt
			  FROM WTM_COMP_CREATE A
			 INNER JOIN WTM_WORKTIME_CLOSE B
			    ON A.TENANT_ID = B.TENANT_ID
			   AND A.ENTER_CD = B.ENTER_CD
			   AND A.YMD BETWEEN B.SYMD AND B.EYMD
			 INNER JOIN WTM_PROPERTIE C
			    ON A.TENANT_ID = C.TENANT_ID
			   AND A.ENTER_CD = C.ENTER_CD
			   AND C.INFO_KEY = 'OPTION_COMP_CODE'
			 WHERE B.WORKTIME_CLOSE_ID = ${worktimeCloseId}
			   AND A.ALLOW_MINUTE > 0
        ]]>
    </select>
    
    <update id="insertErrorLog" parameterType="hashmap">
		INSERT INTO WTM_ERR_LOG (TENANT_ID, ENTER_CD, OBJECT_NM, ERR_LOCATION, ERR_LOG, ERR_MSG, UPDATE_DATE)
		SELECT ${tenantId}, #{enterCd}, 'CLOSE_DAY', '10', 'NO DATA', CONCAT(#{enterCd}, '/', #{symd}, '~' , #{eymd}, '/', #{msg}), NOW()
		FROM DUAL;
	</update>
    
    <update id="insertErrorLogBatch" parameterType="hashmap">
		INSERT INTO WTM_ERR_LOG (TENANT_ID, ENTER_CD, OBJECT_NM, ERR_LOCATION, ERR_LOG, ERR_MSG, UPDATE_DATE)
		SELECT ${tenantId}, #{enterCd}, #{type}, '10', 'NO DATA', CONCAT(#{enterCd}, '/', #{symd}, '~' , #{eymd}, '/', #{msg}), NOW()
		FROM DUAL;
	</update>
	
    <select id="isWorkClose" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT COUNT(*) as workCloseCnt
			  FROM WTM_WORK_CALENDAR
			 WHERE TENANT_ID = ${tenantId}
			   AND ENTER_CD = #{enterCd}
			   AND YMD BETWEEN #{symd} AND #{eymd}
			   AND IFNULL(WORK_CLOSE_YN, 'N') = 'Y'
			   AND (#{sabun} IS NULL OR #{sabun} = '' OR SABUN = #{sabun})
        ]]>
    </select>
    
    <update id="deleteWorktimeDayClose" parameterType="hashmap">
		DELETE FROM WTM_WORKTIME_DAY_CLOSE
		 WHERE WORKTIME_CLOSE_ID = #{worktimeCloseId}
		   AND YMD BETWEEN #{symd} AND #{eymd}
		   AND (#{sabun} IS NULL OR #{sabun} = '' OR SABUN = #{sabun})
	</update>
    
    <select id="getLateAndLeaveAndAbsenceCode" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT MAX(CASE WHEN P.TAA_INFO_CD='LATE' THEN P.TAA_CD ELSE NULL END) AS lateCd -- 지각
			     , MAX(CASE WHEN P.TAA_INFO_CD='LEAVE' THEN P.TAA_CD ELSE NULL END) AS leaveCd -- 조퇴
			     , MAX(CASE WHEN P.TAA_INFO_CD='ABSENCE' THEN P.TAA_CD ELSE NULL END) AS absenceCd -- 결근
			  FROM WTM_TAA_CODE P
			 WHERE P.TENANT_ID = ${tenantId}
			   AND P.ENTER_CD = #{enterCd}
			   AND P.TAA_INFO_CD IN ('LATE', 'LEAVE', 'ABSENCE')
        ]]>
    </select>
    
    <select id="isWorkType" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT COUNT(*) AS emptyWorkTypeCnt
			  FROM WTM_WORK_CALENDAR A
			  JOIN WTM_FLEXIBLE_EMP B
			    ON A.TENANT_ID = B.TENANT_ID
			   AND A.ENTER_CD = B.ENTER_CD
			   AND A.SABUN = B.SABUN
			   AND A.YMD BETWEEN B.SYMD AND B.EYMD
			 WHERE A.TENANT_ID = ${tenantId}
			   AND A.ENTER_CD = #{enterCd}
			   AND A.YMD BETWEEN #{symd} AND #{eymd}
			   AND IFNULL(A.WORK_CLOSE_YN, 'N') = 'N'
			   AND (B.WORK_TYPE_CD IS NULL OR B.WORK_TYPE_CD='')
			   AND (#{sabun} IS NULL OR #{sabun} = '' OR A.SABUN = #{sabun})
        ]]>
    </select>
    
    <update id="insertWorktimeDayClose" parameterType="hashmap">
		INSERT INTO WTM_WORKTIME_DAY_CLOSE (WORKTIME_CLOSE_ID, SABUN, YMD, WORK_TYPE_CD, TIME_CD_MGR_ID, HOLIDAY_YN, UPDATE_DATE, UPDATE_ID) 
		SELECT #{worktimeCloseId} AS worktimeCloseId
		     , A.SABUN AS sabun
			  , A.YMD AS ymd
			  , B.WORK_TYPE_CD AS workTypeCd
			  , A.TIME_CD_MGR_ID AS timeCdMgrId
			  , A.HOLIDAY_YN AS holidayYn
			  , NOW()
			  , '0'
		  FROM WTM_WORK_CALENDAR A
		  JOIN WTM_FLEXIBLE_EMP B
		    ON A.TENANT_ID = B.TENANT_ID
		   AND A.ENTER_CD = B.ENTER_CD
		   AND A.SABUN = B.SABUN
		   AND A.YMD BETWEEN B.SYMD AND B.EYMD
		 WHERE A.TENANT_ID = ${tenantId}
		   AND A.ENTER_CD = #{enterCd}
		   AND A.YMD BETWEEN #{symd} AND #{eymd}
		   AND IFNULL(A.WORK_CLOSE_YN, 'N') = 'N'
		   AND (#{sabun} IS NULL OR #{sabun} = '' OR A.SABUN = #{sabun})
	</update>
	
    <update id="updateWorktimeDayClose" parameterType="hashmap">
		UPDATE WTM_WORKTIME_DAY_CLOSE AA
		  JOIN (			 
		SELECT TENANT_ID
			  , ENTER_CD
			  , SABUN
			  , YMD
		     , SUM(A.WORK_MINUTE)-SUM(A.BREAK_MINUTE) as WORK_MINUTE
		     , SUM(A.OT_MINUTE)-SUM(A.BREAK_OT_MINUTE) as OT_MINUTE
			  , SUM(A.OTN_MINUTE)-SUM(A.BREAK_NIGHT_MINUTE) as OTN_MINUTE
			  , SUM(A.LATE_MINUTE) as LATE_MINUTE
			  , SUM(A.LEAVE_MINUTE) as  LEAVE_MINUTE
			  , SUM(A.ABSENCE_MINUTE) as ABSENCE_MINUTE
			  , SUM(A.PAY_MINUTE) as PAY_MINUTE
			  , SUM(A.NONPAY_MINUTE) as NONPAY_MINUTE
			  , CASE WHEN (SELECT HOLIDAY_YN FROM WTM_WORK_CALENDAR WHERE TENANT_ID = A.TENANT_ID AND ENTER_CD = A.ENTER_CD AND SABUN = A.SABUN AND YMD = A.YMD ) = 'Y'
			              AND (SUM(A.WORK_MINUTE)-SUM(A.BREAK_MINUTE)>0 OR SUM(A.OT_MINUTE)-SUM(A.BREAK_OT_MINUTE)>0 OR SUM(A.OTN_MINUTE)-SUM(A.BREAK_NIGHT_MINUTE)>0) 
						THEN (SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END AS SUBS_YN
							     FROM WTM_WORK_DAY_RESULT X
							     JOIN WTM_OT_APPL Y
							       ON X.APPL_ID = Y.APPL_ID
							      AND F_WTM_NVL(Y.CANCEL_YN, 'N') = 'N'
						        JOIN WTM_OT_SUBS_APPL Z
							       ON Y.OT_APPL_ID = Z.OT_APPL_ID
							      AND F_WTM_NVL(Z.CANCEL_YN, 'N') = 'N'
							     JOIN WTM_APPL Q
							       ON Z.APPL_ID = Q.APPL_ID
							      AND Q.APPL_STATUS_CD = '99'
							    WHERE X.TENANT_ID = A.TENANT_ID
							      AND X.ENTER_CD = A.ENTER_CD
							      AND X.SABUN = A.SABUN
							      AND X.YMD = A.YMD)
			         ELSE 'N' END as SUB_YN 
		  FROM (SELECT R.TENANT_ID
		              , R.ENTER_CD
		              , R.SABUN
		              , R.YMD
		              , SUM(CASE WHEN (TIME_TYPE_CD IN ('BASE', 'REGA') OR (F_WTM_GET_EMP_DAY_OPTION(R.TENANT_ID, R.ENTER_CD, R.SABUN, R.YMD, 'TAA_TIME_YN') = 'Y' AND TIME_TYPE_CD = 'TAA')) THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS WORK_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'EXCEPT' AND R.TAA_CD = 'BREAK' THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS BREAK_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD IN ('OT', 'FIXOT') THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS OT_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'EXCEPT' AND R.TAA_CD IN ('BREAK_OT', 'BREAK_FIXOT') THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS BREAK_OT_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'NIGHT' THEN F_WTM_NVL(APPR_MINUTE,0) ELSE 0 END) AS OTN_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'EXCEPT' AND R.TAA_CD = 'BREAK_NIGHT' THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS BREAK_NIGHT_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'LLA' AND R.TAA_CD = #{lateCd} THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS LATE_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'LLA' AND R.TAA_CD = #{leaveCd} THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS LEAVE_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'LLA' AND R.TAA_CD = #{absenceCd} THEN IFNULL(APPR_MINUTE,0) ELSE 0 END) AS ABSENCE_MINUTE
						  , SUM(CASE WHEN TIME_TYPE_CD = 'TAA' AND C.PAY_YN = 'Y' THEN R.APPR_MINUTE ELSE 0 END) AS PAY_MINUTE
		              , SUM(CASE WHEN TIME_TYPE_CD = 'TAA' AND C.PAY_YN = 'N' THEN R.APPR_MINUTE ELSE 0 END) AS NONPAY_MINUTE
					  FROM WTM_WORK_DAY_RESULT R
					  LEFT OUTER JOIN WTM_TAA_CODE C
					    ON R.TENANT_ID = C.TENANT_ID
					   AND R.ENTER_CD = C.ENTER_CD
					   AND R.TAA_CD = C.TAA_CD
					 WHERE R.TENANT_ID = ${tenantId}
					   AND R.ENTER_CD = #{enterCd}
					   AND R.YMD BETWEEN #{symd} AND #{eymd}
					   AND (#{sabun} IS NULL OR #{sabun} = '' OR R.SABUN = #{sabun})
					 GROUP BY R.TENANT_ID, R.ENTER_CD, R.SABUN, R.YMD) A
		GROUP BY TENANT_ID, ENTER_CD, SABUN, YMD ) BB
		    ON AA.SABUN = BB.SABUN
		   AND AA.YMD = BB.YMD
		   SET AA.WORK_MINUTE = IFNULL(BB.WORK_MINUTE,0)
			  , AA.OT_MINUTE = IFNULL(BB.OT_MINUTE,0) + IFNULL(BB.OTN_MINUTE,0)
			  , AA.OTN_MINUTE = IFNULL(BB.OTN_MINUTE,0)
			  , AA.NONPAY_MINUTE = IFNULL(BB.NONPAY_MINUTE,0)
			  , AA.PAY_MINUTE = IFNULL(BB.PAY_MINUTE,0)
			  , AA.LATE_MINUTE = IFNULL(BB.LATE_MINUTE,0)
			  , AA.LEAVE_MINUTE = IFNULL(BB.LEAVE_MINUTE,0)
			  , AA.ABSENCE_MINUTE = IFNULL(BB.ABSENCE_MINUTE,0)
			  , AA.SUB_YN = BB.SUB_YN
		 WHERE AA.WORKTIME_CLOSE_ID = #{worktimeCloseId}
	</update>
	
	<update id="updateWorktimeNight" parameterType="hashmap">
	<![CDATA[
		UPDATE WTM_WORKTIME_DAY_CLOSE X 
    	  JOIN (
			SELECT ${worktimeCloseId} AS WORKTIME_CLOSE_ID, D.TENANT_ID, D.ENTER_CD, D.SABUN, D.YMD
				 , F_WTM_CALC_MINUTE( F_WTM_DATE_FORMAT(D.NIGHT_SDATE, 'HI') ,  F_WTM_DATE_FORMAT(D.NIGHT_EDATE, 'HI'), '','', '') -
				     SUM(F_WTM_CALC_MINUTE(B.SHM, B.EHM, F_WTM_DATE_FORMAT(D.NIGHT_SDATE, 'HI') ,  F_WTM_DATE_FORMAT(D.NIGHT_EDATE, 'HI'), '' )) AS CM
			  FROM WTM_WORK_CALENDAR C
			  JOIN (	SELECT TENANT_ID, ENTER_CD, SABUN, YMD, NIGHT_SDATE, NIGHT_EDATE
			           FROM (SELECT TENANT_ID, ENTER_CD, SABUN, YMD, GREATEST(APPR_SDATE, F_WTM_TO_DATE(CONCAT(YMD, '220000'), 'YMDHIS')) AS NIGHT_SDATE, 
								 LEAST(APPR_EDATE, F_WTM_DATE_ADD(F_WTM_TO_DATE(CONCAT(YMD, '060000'), 'YMDHIS'), 1, 'D')) AS NIGHT_EDATE
								  FROM WTM_WORK_DAY_RESULT
								 WHERE TENANT_ID = ${tenantId}
								   AND ENTER_CD = #{enterCd}
								   AND (#{sabun} IS NULL OR #{sabun} = '' OR SABUN = #{sabun})
								   AND YMD BETWEEN #{symd} AND #{eymd}
								   AND TIME_TYPE_CD IN ('BASE', 'FIXOT')
								   AND APPR_SDATE IS NOT NULL
								   AND APPR_EDATE IS NOT NULL
								   AND (APPR_SDATE <= F_WTM_DATE_ADD(F_WTM_TO_DATE(CONCAT(YMD, '060000'), 'YMDHIS'), 1, 'D')
									     AND
										APPR_EDATE >= F_WTM_TO_DATE(CONCAT(YMD, '220000'), 'YMDHIS')
										)
							)DD 
						WHERE DD.NIGHT_SDATE != DD.NIGHT_EDATE) D 
			    ON C.TENANT_ID = D.TENANT_ID
			   AND C.ENTER_CD = D.ENTER_CD
			   AND C.YMD = D.YMD
			   AND C.SABUN = D.SABUN
			  JOIN WTM_TIME_CD_MGR T
			    ON C.TIME_CD_MGR_ID = T.TIME_CD_MGR_ID
			   AND T.BREAK_TYPE_CD = 'MGR'
			  LEFT OUTER JOIN WTM_TIME_BREAK_MGR B
			    ON T.TIME_CD_MGR_ID = B.TIME_CD_MGR_ID 
			 WHERE C.TENANT_ID = ${tenantId}
			   AND C.ENTER_CD = #{enterCd}
			   AND (#{sabun} IS NULL OR #{sabun} = '' OR C.SABUN = #{sabun})
			   AND C.YMD BETWEEN #{symd} AND #{eymd}
			GROUP BY D.TENANT_ID, D.ENTER_CD, D.SABUN, D.YMD		
			) XX
		    ON X.WORKTIME_CLOSE_ID = XX.WORKTIME_CLOSE_ID
			AND X.SABUN = XX.SABUN
		   AND X.YMD = XX.YMD
		   AND XX.CM > 0
		   SET X.OTN_MINUTE = IFNULL(X.OTN_MINUTE,0) + IFNULL(XX.CM,0)
		 WHERE X.WORKTIME_CLOSE_ID = ${worktimeCloseId}
		]]>
	</update>
    
    <select id="monthWorkClose" statementType="CALLABLE" parameterType="java.util.HashMap" >
  		{ call P_WTM_CLOSE_MONTH_N( 
  				#{tenantId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{enterCd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{worktimeCloseId, jdbcType=BIGINT, javaType=java.lang.Long, mode=IN}
  			  , #{sYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{eYmd, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{sabun, jdbcType=VARCHAR, javaType=java.lang.String, mode=IN}
  			  , #{retCode,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  , #{retMsg,jdbcType=VARCHAR, javaType=java.lang.String, mode=OUT}
  			  ) }
  	</select>


	<select id="getClosedDayWorkInfo" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT
				WORK_TYPE_CD as workCd,
				IFNULL(SUM( WORK_MINUTE ),0) nWorkMinute,
				IFNULL(SUM( CASE WHEN HOLIDAY_YN = 'N' THEN OT_MINUTE ELSE 0 END ),0) nOtMinute,
				IFNULL(SUM( CASE WHEN HOLIDAY_YN = 'N' THEN OTN_MINUTE ELSE 0 END ),0) nOtnMinute,
				IFNULL(SUM( CASE WHEN HOLIDAY_YN = 'Y' AND IFNULL( SUB_YN, 'N' )= 'N' AND OT_MINUTE > 480 THEN 480 WHEN HOLIDAY_YN = 'Y' AND IFNULL( SUB_YN, 'N' )= 'N' AND OT_MINUTE <= 480 THEN OT_MINUTE ELSE 0 END ),0) nHolMinute,
				IFNULL(SUM( CASE WHEN HOLIDAY_YN = 'Y' AND IFNULL( SUB_YN, 'N' )= 'N' AND OT_MINUTE > 480 THEN OTN_MINUTE +( OT_MINUTE - 480 ) WHEN HOLIDAY_YN = 'Y' THEN OTN_MINUTE -- 20200413 효정수정 심야근무는 그냥 보상에 포함되어야 함으로 SUNYN 체크 무시함
			 				ELSE 0 END ),0) nHolOtMinute,
				IFNULL(SUM( NONPAY_MINUTE ),0) nNonpayMinute,
				IFNULL(SUM( PAY_MINUTE ),0) nPayMinute,
				IFNULL(SUM( LATE_MINUTE ),0) nLateMinute,
				IFNULL(SUM( LEAVE_MINUTE ),0) nLeaveMinute,
				IFNULL(SUM( ABSENCE_MINUTE ),0) nAbsenceMinute,
				IFNULL(SUM( CASE WHEN HOLIDAY_YN = 'Y' AND IFNULL( SUB_YN, 'N' )= 'Y' THEN OT_MINUTE ELSE 0 END ),0) nSubHolMinute
			from
				WTM_WORKTIME_DAY_CLOSE
			where
				WORKTIME_CLOSE_ID = #{worktimeCloseId}
			and sabun = #{sabun}
			and YMD BETWEEN #{sYmd} and #{eYmd}
		]]>
	</select>

	<select id="getTargerMonthlyCloseUserList" parameterType="hashmap" resultType="hashmap">
		<![CDATA[
			SELECT 	WORKTIME_CLOSE_ID worktimeCloseId
					, SABUN sabun
					, WORK_TYPE_CD workTypeCd
			FROM 	WTM_WORKTIME_DAY_CLOSE
			WHERE 	WORKTIME_CLOSE_ID = #{worktimeCloseId}
			AND 	YMD BETWEEN #{sYmd} and #{eYmd}
		]]>
		<if test="sabun!=null and !sabun.equals('')">
			AND 	SABUN = #{sabun}
		</if>
		GROUP BY WORKTIME_CLOSE_ID, SABUN, WORK_TYPE_CD
		ORDER BY SABUN

	</select>

	<select id="getSubAddMinute" parameterType="java.util.HashMap" resultType="java.lang.Integer">
		<![CDATA[
			SELECT IFNULL(SUM(C.SUBS_MINUTE), 0) subsMinute
			 FROM WTM_OT_APPL B
			 INNER JOIN WTM_OT_SUBS_APPL C
				ON B.OT_APPL_ID = C.OT_APPL_ID
			   AND F_WTM_NVL(C.CANCEL_YN, 'N') = 'N'
			 INNER JOIN WTM_APPL D
				ON C.APPL_ID = D.APPL_ID
			   AND D.APPL_STATUS_CD = '99'
			 WHERE D.TENANT_ID = #{tenantId}
			   AND D.ENTER_CD = #{enterCd}
			   AND B.SABUN = #{sabun}
			   AND F_WTM_NVL(B.CANCEL_YN, 'N') = 'N'
			   AND B.YMD BETWEEN #{sYmd} AND #{eYmd}
			   AND C.SUB_YMD BETWEEN #{sYmd} AND #{eYmd}
		]]>
	</select>


	<delete id="deleteWorktimeMonthClose" parameterType="hashmap" >
		<![CDATA[
			DELETE FROM WTM_WORKTIME_MON_CLOSE
			WHERE WORKTIME_CLOSE_ID = #{worktimeCloseId}
			AND SABUN = #{sabun}
			AND WORK_TYPE_CD = #{workTypeCd}
		]]>
	</delete>


	<insert id="insertWorktimeMonthClose" parameterType="hashmap">
		<![CDATA[
			INSERT
				INTO
					WTM_WORKTIME_MON_CLOSE(
						WORKTIME_CLOSE_ID,
						SABUN,
						WORK_TYPE_CD,
						SYMD,
						EYMD,
						BASE_MINUTE,
						BASE_OT_MINUTE,
						FIX_OT_MINUTE,
						WORK_MINUTE,
						OT_MINUTE,
						OTN_MINUTE,
						HOL_MINUTE,
						HOL_OT_MINUTE,
						A_WORK_MINUTE,
						A_OT_MINUTE,
						A_OTN_MINUTE,
						A_HOL_MINUTE,
						A_HOL_OT_MINUTE,
						A_NONPAY_MINUTE,
						A_PAY_MINUTE,
						ABSENCE_MINUTE,
						LATE_MINUTE,
						LEAVE_MINUTE,
						UPDATE_ID
					)
				VALUES(
					#{worktimeCloseId},
					#{sabun},
					#{workTypeCd},
					#{symd},
					#{eymd},
					#{nBaseMinute},
					#{nBaseOtMinute},
					#{nFixOtMinute},
					#{nWorkMinute},
					#{nOtMinute},
					#{nOtnMinute},
					#{nHolMinute},
					#{nHolOtMinute},
					#{nAWorkMinute},
					#{nAOtMinute},
					#{nAOtnMinute},
					#{nAHolMinute},
					#{nAHolOtMinute},
					#{nNonpayMinute},
					#{nPayMinute},
					#{nAbsenceMinute},
					#{nLateMinute},
					#{nLeaveMinute},
					'worktimeMonthClose'
				)
		]]>
	</insert>

	<select id="selectFixotMinute" parameterType="hashmap" resultType="hashmap">
		SELECT A.FIXOT_USE_LIMIT AS n_fix_ot_minute
		FROM WTM_FLEXIBLE_STD_MGR A
				 INNER JOIN WTM_FLEXIBLE_EMP B
							ON A.FLEXIBLE_STD_MGR_ID = B.FLEXIBLE_STD_MGR_ID
		WHERE B.TENANT_ID = #{tenantId}
		  AND B.ENTER_CD = #{enterCd}
		  AND B.SABUN = #{sabun}
		  AND #{sYmd} BETWEEN B.SYMD AND B.EYMD
		  AND B.WORK_TYPE_CD = #{workTypeCd}
	</select>

</mapper>
