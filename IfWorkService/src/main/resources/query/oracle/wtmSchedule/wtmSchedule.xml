<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmScheduleMapper">
    
    <select id="getWtmCloseDay" parameterType="map" resultType="hashmap">
        <![CDATA[
        	SELECT AA.ENTER_CD AS enterCd, AA.SABUN AS sabun, AA.YMD AS ymd
              FROM (SELECT A.ENTER_CD, A.SABUN, A.YMD, MIN(F_WTM_DATE_FORMAT(B.PLAN_SDATE, 'YMD')) AS SDATE, MAX(F_WTM_DATE_FORMAT(B.PLAN_EDATE, 'YMD')) AS EDATE
                    FROM WTM_WORK_CALENDAR A
                   INNER JOIN WTM_WORK_DAY_RESULT B
                       ON A.TENANT_ID = B.TENANT_ID
                      AND A.ENTER_CD = B.ENTER_CD
                      AND A.SABUN = B.SABUN
                      AND A.YMD = B.YMD
                   WHERE B.TIME_TYPE_CD IN ('BASE', 'REGA', 'OT', 'FIXOT', 'NIGTH')	-- 간주근무나 기본근무일때)
                      AND A.TENANT_ID = #{tenantId}
                      AND A.YMD = #{ymd}
                   GROUP BY A.ENTER_CD, A.SABUN, A.YMD
                   ) AA
             WHERE ((#{closeType} = 'A' AND AA.SDATE = AA.EDATE)
                 OR (#{closeType} = 'B' AND AA.SDATE != AA.EDATE))
            UNION
			SELECT A.ENTER_CD, A.SABUN, A.YMD
			  FROM WTM_WORK_CALENDAR A
			  LEFT OUTER JOIN WTM_WORK_DAY_RESULT B
			     ON A.TENANT_ID = B.TENANT_ID
			    AND A.ENTER_CD = B.ENTER_CD
			    AND A.SABUN = B.SABUN
			    AND A.YMD = B.YMD
			    AND A.ENTRY_SDATE <= B.PLAN_EDATE
			    AND A.ENTRY_EDATE >= B.PLAN_SDATE
			 WHERE A.TENANT_ID = #{tenantId}
			    AND A.YMD < #{ymd}
			    AND A.HOLIDAY_YN = 'N'
			    AND B.TIME_TYPE_CD IN ('BASE', 'OT', 'FIXOT', 'NIGHT')
			    AND A.ENTRY_SDATE IS NOT NULL AND A.ENTRY_EDATE IS NOT NULL
				 AND B.APPR_SDATE IS NULL AND B.APPR_EDATE IS NULL
			 GROUP BY A.ENTER_CD, A.SABUN, A.YMD
			 UNION
			SELECT A.ENTER_CD, A.SABUN, A.YMD
			  FROM WTM_WORK_CALENDAR A
			  JOIN WTM_WORK_DAY_RESULT B
			     ON A.TENANT_ID = B.TENANT_ID
			    AND A.ENTER_CD = B.ENTER_CD
			    AND A.SABUN = B.SABUN
			    AND A.YMD = B.YMD
			    AND A.ENTRY_SDATE <= B.PLAN_EDATE
			    AND A.ENTRY_EDATE >= B.PLAN_SDATE
			 WHERE A.TENANT_ID = #{tenantId}
			    AND A.YMD < #{ymd}
			    AND A.HOLIDAY_YN = 'Y'
			    AND B.TIME_TYPE_CD IN ('BASE', 'OT', 'FIXOT', 'NIGHT')
			    AND A.ENTRY_SDATE IS NOT NULL AND A.ENTRY_EDATE IS NOT NULL
				 AND B.PLAN_SDATE IS NOT NULL AND B.PLAN_EDATE IS NOT NULL 
				 AND B.APPR_SDATE IS NULL AND B.APPR_EDATE IS NULL
			 GROUP BY A.ENTER_CD, A.SABUN, A.YMD
			ORDER BY YMD, SABUN
        ]]>
    </select>

	<select id="getOtList" parameterType="map" resultType="hashmap">
		<![CDATA[
			SELECT EMAIL, TENANT_ID, ENTER_CD, SABUN, TOT, F_WTM_GET_LEADER_EMAIL(TENANT_ID, ENTER_CD, SABUN) AS LEADER, EMP_NM  FROM (
				SELECT EMAIL, TENANT_ID, ENTER_CD, SABUN, SUM(TOT) AS TOT, EMP_NM  FROM(
					SELECT A.EMAIL, D.TENANT_ID, D.ENTER_CD, D.SABUN, D.YMD, EMP_NM, 
						CASE WHEN D.YMD < TO_CHAR(SYSDATE, 'YYYYMMDD') THEN D.APPR_MINUTE 
							WHEN D.YMD = TO_CHAR(SYSDATE, 'YYYYMMDD') AND C.ENTRY_SDATE IS NOT NULL AND C.ENTRY_EDATE IS NOT NULL THEN D.APPR_MINUTE
							WHEN D.YMD = TO_CHAR(SYSDATE, 'YYYYMMDD') AND (C.ENTRY_SDATE = NULL OR C.ENTRY_EDATE = NULL ) THEN D.PLAN_MINUTE
							WHEN D.YMD > TO_CHAR(SYSDATE, 'YYYYMMDD') THEN D.PLAN_MINUTE
							END AS TOT
					FROM WTM_WORK_DAY_RESULT D
						JOIN WTM_WORK_CALENDAR C ON C.TENANT_ID=D.TENANT_ID AND C.ENTER_CD = D.ENTER_CD AND C.SABUN=D.SABUN AND C.YMD=D.YMD
						JOIN WTM_EMP_ADDR A ON A.TENANT_ID=D.TENANT_ID AND A.ENTER_CD = D.ENTER_CD AND A.SABUN=D.SABUN 
						JOIN WTM_EMP_HIS B ON B.TENANT_ID=D.TENANT_ID AND B.ENTER_CD = D.ENTER_CD AND B.SABUN=D.SABUN AND B.SYMD < TO_CHAR(SYSDATE, 'YYYYMMDD') AND B.EYMD >= TO_CHAR(SYSDATE, 'YYYYMMDD')
					WHERE D.YMD like TO_CHAR(SYSDATE, 'YYYYMM') || '%'
						AND D.TIME_TYPE_CD IN ('OT', 'FIXOT', 'NIGHT')
					--AND D.SABUN='990362'
					ORDER BY SABUN, YMD DESC
				) GROUP BY TENANT_ID, ENTER_CD, SABUN, EMAIL, EMP_NM )
			WHERE TOT > #{stdOtTime}
		]]>
	</select>
</mapper>