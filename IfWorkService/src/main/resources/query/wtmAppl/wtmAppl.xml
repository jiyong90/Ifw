<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.isu.ifw.mapper.WtmApplMapper">
	<select id="getWtmApplLine" parameterType="map" resultType="wtmApplLine">
        <![CDATA[
			SELECT X.APPR_SEQ, X.SABUN, F_WTM_GET_EMP_NM(#{tenantId}, #{enterCd}, X.SABUN, #{d}) AS EMP_NM
			  FROM (
				SELECT 1 AS APPR_SEQ, E1.SABUN
				  FROM WTM_EMP_HIS E
				  JOIN WTM_EMP_HIS E1
				    ON E.TENANT_ID = E1.TENANT_ID
				   AND E.ENTER_CD = E1.ENTER_CD
				   AND E1.LEADER_YN = 'Y'
			  	 WHERE E.ENTER_CD = #{enterCd}
				   AND E.TENANT_ID = #{tenantId}
				   AND E.SABUN = #{sabun}
				   AND E1.ORG_PATH = F_WTM_GET_ORG_PATH_BY_LVL(E.TENANT_ID, E.ENTER_CD, E.SABUN, #{d}, 1)
				 UNION
				SELECT 2 AS APPR_SEQ, E1.SABUN
				  FROM WTM_EMP_HIS E
				  JOIN WTM_EMP_HIS E1
				    ON E.TENANT_ID = E1.TENANT_ID
				   AND E.ENTER_CD = E1.ENTER_CD
				   AND E1.LEADER_YN = 'Y'
				 WHERE E.ENTER_CD = #{enterCd}
				   AND E.TENANT_ID = #{tenantId}
				   AND E.SABUN = #{sabun}
				   AND E1.ORG_PATH = F_WTM_GET_ORG_PATH_BY_LVL(E.TENANT_ID, E.ENTER_CD, E.SABUN, #{d}, 2)
				 UNION
				SELECT 3 AS APPR_SEQ, E1.SABUN
				  FROM WTM_EMP_HIS E
				  JOIN WTM_EMP_HIS E1
				    ON E.TENANT_ID = E1.TENANT_ID
				   AND E.ENTER_CD = E1.ENTER_CD
				   AND E1.LEADER_YN = 'Y'
				 WHERE E.ENTER_CD = #{enterCd}
				   AND E.TENANT_ID = #{tenantId}
				   AND E.SABUN = #{sabun}
				   AND E1.ORG_PATH = F_WTM_GET_ORG_PATH_BY_LVL(E.TENANT_ID, E.ENTER_CD, E.SABUN, #{d}, 3) 
				) X 
				ORDER BY X.APPR_SEQ 
        ]]>
    </select>
    
    <select id="getWtmApplLineByApplId" parameterType="Long" resultType="wtmApplLine">
        <![CDATA[
			SELECT 1 AS APPR_TYPE_CD
			     , 0 AS APPR_SEQ
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'APPR_TYPE_CD', 1, A.APPL_YMD) AS APPR_TYPE_NM
			     , A.APPL_SABUN AS SABUN
			     , F_WTM_GET_EMP_NM(A.TENANT_ID, A.ENTER_CD, A.APPL_SABUN, A.APPL_YMD) AS EMP_NM
			     , F_WTM_DATE_FORMAT(A.APPL_YMD, '%Y%m%d') AS APPR_DATE
			     , NULL AS APPR_STATUS_CD
			     , NULL AS APPR_STATUS_NM
			     , NULL AS APPR_OPINION
			  FROM WTM_APPL A
			 WHERE A.APPL_ID = #{applId}
			UNION ALL
			SELECT L.APPR_TYPE_CD
			     , L.APPR_SEQ
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'APPR_TYPE_CD', L.APPR_TYPE_CD, A.APPL_YMD) AS APPR_TYPE_NM
			     , L.APPR_SABUN AS SABUN
			     , F_WTM_GET_EMP_NM(A.TENANT_ID, A.ENTER_CD, L.APPR_SABUN, A.APPL_YMD) AS EMP_NM
			     , F_WTM_DATE_FORMAT(L.APPR_DATE, '%Y%m%d') AS APPR_DATE
			     , L.APPR_STATUS_CD
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'APPR_STATUS_CD', L.APPR_STATUS_CD, A.APPL_YMD) AS APPR_STATUS_NM
			     , L.APPR_OPINION
			  FROM WTM_APPL_LINE L
			  JOIN WTM_APPL A
			    ON L.APPL_ID = A.APPL_ID
			 WHERE L.APPL_ID = #{applId}
			ORDER BY APPR_SEQ
        ]]>
    </select>
    
    <select id="calcWorkDay" parameterType="map" resultType="map">
        <![CDATA[
			SELECT COUNT(*) AS WORK_CNT
			  FROM WTM_DAY_MGR D
			 WHERE 
				NOT EXISTS
				(SELECT * 
				   FROM  WTM_HOLIDAY_MGR H
				  WHERE H.TENANT_ID = #{tenantId}
				    AND H.ENTER_CD = #{enterCd}
					AND H.HOLIDAY_YMD = D.SUN_YMD)
			  AND D.SUN_YMD BETWEEN #{sYmd} AND #{eYmd} 
        ]]>
    </select>
    
    <select id="getApprList" parameterType="map" resultType="hashmap">
        <![CDATA[
			SELECT L.APPL_ID AS applId
			     , L.APPR_SEQ AS apprSeq
			     , L.APPR_SABUN AS apprSabun
			     , L.APPR_DATE AS apprDate
			     , L.APPR_STATUS_CD AS apprStatusCd
			     , L.APPR_TYPE_CD AS apprTypeCd
			     , L.APPR_OPINION AS apprOpinion
			     , A.APPL_CD AS applCd
			     , (SELECT APPL_NM FROM WTM_APPL_CODE WHERE TENANT_ID = A.TENANT_ID AND ENTER_CD = A.ENTER_CD AND APPL_CD = A.APPL_CD) AS applNm
			     , A.APPL_SABUN AS applSabun
			     , F_WTM_GET_EMP_NM(A.TENANT_ID, A.ENTER_CD, A.APPL_SABUN, A.APPL_YMD ) AS empNm
			     , A.APPL_YMD AS applYmd
			     , A.APPL_IN_SABUN AS applInSabun
			     , A.APPL_STATUS_CD AS applStatusCd
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'APPL_STATUS_CD', A.APPL_STATUS_CD, A.APPL_YMD) AS applStatusNm
			     , FA.FLEXIBLE_APPL_ID AS flexibleApplId
			     , FA.SYMD AS sYmd
			     , FA.EYMD AS eYmd
			     , NULL AS reasonCd
			     , NULL AS reasonNm
			     , FA.REASON AS reason
			  FROM WTM_APPL A
			  JOIN WTM_APPL_LINE L
			    ON L.APPL_ID = A.APPL_ID
			  JOIN WTM_FLEXIBLE_APPL FA
			    ON A.APPL_ID = FA.APPL_ID
			 WHERE A.TENANT_ID = #{tenantId}
			   AND A.ENTER_CD = #{enterCd}
			   AND APPR_SABUN = #{empNo}
			   AND L.APPR_STATUS_CD = '10'
			   AND A.APPL_STATUS_CD IN ('21','31')
			UNION ALL
			SELECT L.APPL_ID AS applId
			     , L.APPR_SEQ AS apprSeq
			     , L.APPR_SABUN AS apprSabun
			     , L.APPR_DATE AS apprDate
			     , L.APPR_STATUS_CD AS apprStatusCd
			     , L.APPR_TYPE_CD AS apprTypeCd
			     , L.APPR_OPINION AS apprOpinion
			     , A.APPL_CD AS applCd
			     , (SELECT APPL_NM FROM WTM_APPL_CODE WHERE TENANT_ID = A.TENANT_ID AND ENTER_CD = A.ENTER_CD AND APPL_CD = A.APPL_CD) AS applNm
			     , A.APPL_SABUN AS applSabun
			     , F_WTM_GET_EMP_NM(A.TENANT_ID, A.ENTER_CD, A.APPL_SABUN, A.APPL_YMD ) AS empNm
			     , A.APPL_YMD AS applYmd
			     , A.APPL_IN_SABUN AS applInSabun
			     , A.APPL_STATUS_CD AS applStatusCd
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'APPL_STATUS_CD', A.APPL_STATUS_CD, A.APPL_YMD) AS applStatusNm
			     , OA.OT_APPL_ID AS otApplId
			     , OA.OT_SDATE AS sDate
			     , OA.OT_EDATE AS eDate
			     , OA.REASON_CD AS reasonCd
			     , F_WTM_GET_CODE_NM(A.TENANT_ID, A.ENTER_CD, 'REASON_CD', OA.REASON_CD, A.APPL_YMD) AS reasonNm
			     , OA.REASON AS reason
			  FROM WTM_APPL A
			  JOIN WTM_APPL_LINE L
			    ON L.APPL_ID = A.APPL_ID
			  JOIN WTM_OT_APPL OA
			    ON A.APPL_ID = OA.APPL_ID
			 WHERE A.TENANT_ID = #{tenantId}
			   AND A.ENTER_CD = #{enterCd}
			   AND APPR_SABUN = #{empNo}
			   AND L.APPR_STATUS_CD = '10'
			   AND A.APPL_STATUS_CD IN ('21','31')
        ]]>
    </select>
</mapper>
